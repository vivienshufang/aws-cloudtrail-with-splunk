# How to Setup AWS CouldTrail with Splunk

This document describes how to setup Cloudtail in AWS for API call auditing, and how to setup SpunkAppForAWS to pull Cloudtrail reports into Splunk.

## What is CloudTrail
AWS CloudTrail is an AWS service. When enabled, it captures AWS API calls made by or on behalf of an AWS account and delivers log files to an Amazon S3 bucket. 

## Why use CloudTrail
We monitor file system integrity (e.g. tripwire), and send system logs to central log server as part of the standard setup for a system. For AWS instances, we also need to monitor AWS API calls made to the AWS environment. 

The CloudTrail recorded information includes the identity of the API caller, the time of the API call, the source IP address of the API caller, the request parameters, and the response elements returned by the AWS service. The AWS API call history produced by CloudTrail enables security analysis, resource change tracking, and compliance auditing.

## Install AWSCLI
We use AWSCLI command line tool to create Cloudtrail. There is no Debian Package. To install(or upgrade) the package:

        pip install awscli [--upgrade]

This will install the tool under /opt/aws. 

## Create AWS CloudTrail

Even we don't use all of the available regions to our AWS account, we should still monitor these regions that CloudTrail service is available:

* us-east-1
* us-west-1
* us-west-2
* eu-west-1
* sa-east-1

To enable CloudTrail on these regions, run:

        /usr/sbin/create-cloudtrail

The script calls AWSCLI cloudtrail command to:

* Enable Cloudtrail service
* Create Simple Notification Service (SNS) topic for the Cloudtrail service in each region
* Aggregate all regions audit reports in one S3 bucket in us-west-2

We consolidate all CloudTrails reports into one S3 bucket called its-aws-idg-cloudtrail.stanford.edu. The script takes care of creates necessary access policies. Global events - generated by services that don't have a region, e.g. Identity and Access Management (IAM) - will be logged in us-west-2 region only.

## Create a Simple Queue Service (SQS) 

We will setup one message queue named __its-idg-cloudtrail__ in the primary on us-west-2 region. It subscribes to multiple SNS cloudtrail topics created by create-cloudetrail script.  With one message queue, you only need to setup one data input for Splunk to monitor. 

SQS is needed in Splunk AWS app configuration. Splunk AWS app runs at 1 minute interval to retrieve messages from AWS SQS service. The message body contains the S3 bucket location for the Cloudtrail report. Splunk then calls S3 API to get Cloudtrail reports from the S3 bucket.

## Create IAM user

Most documentations you find require you to create an IAM with "Power Admin" access AWS resources. I create an IAM user and try out different policies to get the minimum access privileges needed.

The IAM user __cloudtrail-splunkapp__  haas the necessary ACLs to read SQS, delete message from SQS, and get data from S3 bucket. The following polices work:

* readonly access to S3 bucket
* readonly access to CloudTrail
* full access to the SQS (it deletes messages after read stuff from the message queue)

## Setup Splunk

### Billing and usage module

This requires to setup billing to send CSV files to a S3 bucket, which doesn't work for our consolidated account - need to ask the payer.

### CloudTrail module

The SplunkAppForAWS needs to be installed on the search head (logsh) and indexers (logindex1 and logindex2). The data input only need to be configured on logindex1 and logindex2 where the app will retrieve audit reports and build the indexes. Splunk search head will do search against the logindex servers. 

Setup data input either on Splunk Settings->Data Input console. If you do it on Splunk console, following the following steps:

* Go to "Settings->Data Inputs" 
* Create a new data input
* Fill out the IAM user's key, secret, SQS name, and the region
* In the "Script iterations" box, type "relaunch", otherwise, the app script will stop running after 2048 runs.
* Click "More Advanced Setting", check Source Type to Manual, and "Source" to aws-cloudtrail

It will generate a __inputs.conf__ file, that can be managed by Puppet.

    logindex-dev:/opt/splunk/etc/apps/launcher/local# more inputs.conf 
    exclude_describe_events = 0
	index = aws-cloudtrail
	interval = 1
	remove_files_when_done = 0
	key_id = key
	secret_key = secret
	sqs_queue = its-aws-idg-cloudtrail
	sqs_queue_region = us-west-2
	sourcetype = aws-cloudtrail
	script_iterations = relaunch

 